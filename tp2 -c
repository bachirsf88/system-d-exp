// partC_atomic.c
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdatomic.h>
#include <time.h>

atomic_llong counter = 0;

static double now_s(void){
    struct timespec ts; clock_gettime(CLOCK_MONOTONIC, &ts);
    return ts.tv_sec + ts.tv_nsec*1e-9;
}

void* worker(void* arg){
    long iters = *(long*)arg;
    for(long i=0;i<iters;i++){
        atomic_fetch_add_explicit(&counter, 1, memory_order_relaxed);
    }
    return NULL;
}

int main(int argc, char** argv){
    long iters = (argc>1)? atol(argv[1]) : 5000000;
    double t0 = now_s();
    pthread_t t1, t2;

    pthread_create(&t1, NULL, worker, &iters);
    pthread_create(&t2, NULL, worker, &iters);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);

    double dt = now_s() - t0;
    printf("Counter=%lld, time=%.3fs\n", (long long)atomic_load(&counter), dt);
    return 0;
}
